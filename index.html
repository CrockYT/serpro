<!DOCTYPE html>
<html lang="ja" id="dropArea" class="drop-area">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://i.imgur.com/oGPxBBy.png" type="image/png">
  <meta property="og:title" content="Serpro">
  <meta property="og:description" content="Minecraftのサーバープロパティファイルを簡単に編集できるツールです。/n 最新アップデート 11/25">
  <meta property="og:image" content="https://i.imgur.com/oGPxBBy.png">
  <title>Serpro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --bg-color: #f9f9f9;
      --text-color: #333;
      --table-bg: #fff;
      --table-border: #ddd;
      --button-bg: var(--primary-color);
      --button-hover-bg: var(--primary-hover-color);
    }

    [data-theme="dark"] {
      --primary-color: #1e90ff;
      --primary-hover-color: #104e8b;
      --bg-color: #2e2e2e;
      --text-color: #f1f1f1;
      --table-bg: #3e3e3e;
      --table-border: #555;
      --button-bg: var(--primary-color);
      --button-hover-bg: var(--primary-hover-color);
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    h1 {
      text-align: center;
      color: var(--text-color);
    }
    
    .drop-area {
      background-color: #f9f9f9;
    }

    .drop-area.dropping {
      background-color: #e0e0e0;
    }

    input[type="file"] {
      display: block;
      margin: 20px auto;
      padding: 10px;
      border: 1px solid var(--table-border);
      border-radius: 4px;
      cursor: pointer;
      max-width: 300px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: var(--table-bg);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
    }

    table.visible {
      opacity: 1;
      transform: translateY(0);
    }

    th, td {
      border: 1px solid var(--table-border);
      padding: 10px;
      text-align: left;
    }

    th {
      background-color: var(--primary-color);
      color: #fff;
    }

    td input, td select {
      width: 95%;
      padding: 5px;
      border: 1px solid var(--table-border);
      border-radius: 4px;
      font-size: 14px;
      background: var(--table-bg);
      color: var(--text-color);
    }

    .button-group {
      text-align: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 4px;
      background-color: var(--button-bg);
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: var(--button-hover-bg);
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: transparent;
      border: none;
      color: var(--primary-color);
      font-size: 24px;
      cursor: pointer;
    }

    .motd-preview {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid var(--table-border);
      border-radius: 4px;
      background-color: #f0f0f0;
      color: #555;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 14px;
      }

      td input, td select {
        font-size: 12px;
      }

      button {
        padding: 8px 15px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" id="themeToggle" aria-label="テーマ切り替え">
    <i class="fas fa-moon"></i>
  </button>

  <h1>Serpro</h1>

  <input type="file" id="fileInput" accept=".properties">

  <table id="propertiesTable" class="hidden">
    <thead>
      <tr>
        <th>設定項目</th>
        <th>値</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="button-group">
    <button id="saveButton" disabled>保存</button>
    <button id="downloadButton" disabled>ダウンロード</button>
    <button id="shareButton" disabled>共有リンク生成</button>
    <button id="loadPresetButton">プリセット読み込み</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';
  
    async function getFirebaseConfig() {
      const response = await fetch('https://ser.cromichan-net.workers.dev/', {
        method: 'GET'
      });
      const config = await response.json();
      return config;
    }
  
    getFirebaseConfig().then(firebaseConfig => {
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      shareButton.addEventListener('click', async () => {
        const base64 = btoa(JSON.stringify(state.properties));
        const shortKey = generateShortKey();

        localStorage.setItem(shortKey, base64);

        await db.collection("properties").add({
          properties: state.properties
        });

        const shortUrl = `${location.origin}${location.pathname}?share=${shortKey}`;
        navigator.clipboard.writeText(shortUrl).then(() => alert('短縮された共有リンクをコピーしました！'));
      });
  
      console.log("Firebaseが正常に初期化されました");
  
    }).catch(error => {
      console.error("Firebaseの設定の取得または初期化中にエラーが発生しました:", error);
    });
  </script>  
  <script>
    const fileInput = document.getElementById('fileInput');
    const propertiesTable = document.getElementById('propertiesTable');
    const propertiesTableBody = propertiesTable.querySelector('tbody');
    const saveButton = document.getElementById('saveButton');
    const downloadButton = document.getElementById('downloadButton');
    const shareButton = document.getElementById('shareButton');
    const loadPresetButton = document.getElementById('loadPresetButton');
    const themeToggle = document.getElementById('themeToggle');
    const dropArea = document.getElementById('dropArea');
    const dropText = document.getElementById('dropText');
    const state = { properties: {} };

    dropArea.addEventListener('dragover', (event) => {
      event.preventDefault();
      dropArea.classList.add('dropping');
      dropText.textContent = 'ここにファイルをドロップしてください';
    });

    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('dropping');
      dropText.textContent = 'ファイルを読み込む';
    });

    dropArea.addEventListener('drop', (event) => {
      event.preventDefault();
      const file = event.dataTransfer.files[0];
      if (file && file.name.endsWith('.properties')) {
        const reader = new FileReader();
        reader.onload = () => loadFile(reader.result);
        reader.readAsText(file);
      } else {
        alert('「.properties」ファイルをドロップしてください');
      }

      dropArea.classList.remove('dropping');
      dropText.textContent = 'ファイルを読み込む';
    });

    const addRow = (key, value) => {
      const row = document.createElement('tr');
      const keyCell = document.createElement('td');
      const valueCell = document.createElement('td');

      keyCell.textContent = key;

      if (key.toLowerCase() === 'motd') {
        const inputField = document.createElement('input');
        inputField.value = value;
        inputField.addEventListener('input', () => {
          state.properties[key] = inputField.value;
        });
        valueCell.appendChild(inputField);
      } else if (value === 'true' || value === 'false') {
        const select = document.createElement('select');
        select.innerHTML = ` 
          <option value="true" ${value === 'true' ? 'selected' : ''}>True</option>
          <option value="false" ${value === 'false' ? 'selected' : ''}>False</option>
        `;
        select.addEventListener('change', () => {
          state.properties[key] = select.value;
        });
        valueCell.appendChild(select);
      } else {
        const inputField = document.createElement('input');
        inputField.value = value;
        inputField.addEventListener('input', () => {
          state.properties[key] = inputField.value;
        });
        valueCell.appendChild(inputField);
      }

      row.appendChild(keyCell);
      row.appendChild(valueCell);
      propertiesTableBody.appendChild(row);
    };

    const updateUI = () => {
      propertiesTableBody.innerHTML = '';
      Object.entries(state.properties).forEach(([key, value]) => addRow(key, value));
      propertiesTable.classList.add('visible');
      saveButton.disabled = false;
      downloadButton.disabled = false;
      shareButton.disabled = false;
    };

    const loadFile = content => {
      content.split('\n').forEach(line => {
        const [key, ...value] = line.split('=');
        if (key && value.length) state.properties[key.trim()] = value.join('=').trim();
      });
      updateUI();
    };

    fileInput.addEventListener('change', event => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = () => loadFile(reader.result);
        reader.readAsText(file);
      }
    });

    saveButton.addEventListener('click', () => {
      const name = prompt('プリセット名を入力してください:');
      if (!name) return;
      const presets = JSON.parse(localStorage.getItem('presets') || '{}');
      presets[name] = state.properties;
      localStorage.setItem('presets', JSON.stringify(presets));
      alert(`プリセット「${name}」を保存しました！`);
    });

    loadPresetButton.addEventListener('click', () => {
      const presets = JSON.parse(localStorage.getItem('presets') || '{}');
      const name = prompt(`プリセット名を選択してください:\n${Object.keys(presets).join('\n')}`);
      if (presets[name]) {
        state.properties = presets[name];
        updateUI();
      } else alert('指定されたプリセットは存在しません。');
    });

    downloadButton.addEventListener('click', () => {
      const blob = new Blob([Object.entries(state.properties).map(([k, v]) => `${k}=${v}`).join('\n')], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'server.properties';
      link.click();
    });

    function generateShortKey() {
      const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let shortKey = '';
      for (let i = 0; i < 6; i++) {
        shortKey += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return shortKey;
    }
  </script>
</body>
</html>
